<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>CourseDetails</title>
    <meta name="description" content="">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="css/course_details.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/css/bootstrap.min.css"
        crossorigin="anonymous">

    <script src="https://use.fontawesome.com/releases/v5.15.1/js/all.js"></script>

    <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-analytics.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.3.2/firebase-auth.js"></script>

    <script src="http://code.jquery.com/jquery-1.7.1.min.js"></script>

    <script>
        var firebaseConfig = {
            apiKey: "AIzaSyBTNIg29kbCt-GhFenHNZa34Xkl8M4k8cw",
            authDomain: "block-5acdc.firebaseapp.com",
            projectId: "block-5acdc",
            storageBucket: "block-5acdc.appspot.com",
            messagingSenderId: "57460143611",
            appId: "1:57460143611:web:3efd4e65ab5898b59fc75e",
            measurementId: "G-31XZGSV3WT"
        };
        firebase.initializeApp(firebaseConfig);
        firebase.analytics();

        var db = firebase.firestore();
    </script>

    <style>
        #lessonSection, #projectSection {
            display: none; 
        }
    </style>

</head>

<body>

    <nav class="navbar navbar-expand-lg navbar-light bg-dark " id="navbar-home">
        <a class="navbar-brand" href="dashboard_stud.html"><i class="fa fa-home fa-2x" id="home"></i></a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav">
            <span class="navbar-toggler-icon"></span>
        </button>

        <div class="collapse navbar-collapse" id="navbarNav">
            <ul class="navbar-nav ml-auto" id="nav-list">
                <li class="nav-item active">
                    <button type="button" class="btn-sm btn btn-primary mr-sm-1">
                        <a class="nav-link" id="nav_text" href="stud_my_projects.html">My Projects</a>
                    </button>
                </li>
                <li><img src="assets/prof.jpeg" height="45" width="45"></li>

                <li class="nav-item dropdown">
                    <a class="nav-link dropdown-toggle" id="nav_text" data-toggle="dropdown"></a>
                    <div class="dropdown-menu dropdown-menu-right">
                        <a class="dropdown-item" href="my_profile.html">My Profile</a>
                        <a class="dropdown-item" href="stud_courselist.html">View Courses</a>
                        <a class="dropdown-item" onclick="signOut()">Logout</a>
                    </div>
                </li>
            </ul>
        </div>
    </nav>

    <div class="container">
        <div class="row">
            <div class="col-12 mt-md-5" id="box">

                <h1 id="courseTitle" class="m-md-3">Course_Title</h1>
                <div id="courseDescription" class="m-md-3"></div>

                <div id="lessonSection">
                    <h3>Lessons</h3>
                    <table class="table table-bordered col-sm-8 ml-md-3">
                        <thead>
                            <tr><th>Name</th><th>View</th></tr>
                        </thead>
                        <tbody id="course_table"></tbody>
                    </table>
                </div>


                <div id="projectSection">
                    <h3>Projects</h3>
                    <table class="table table-bordered col-sm-8 ml-md-3">
                        <thead>
                            <tr><th>Name</th></tr>
                        </thead>
                        <tbody id="course_table1"></tbody>
                    </table>
                </div>

                <br><br>

                <button type="button" id="enrollBtn" class="btn btn-primary ml-md-3" data-toggle="modal"
                    data-target="#exampleModal2">Enroll Now</button>

            </div>
        </div>
    </div>

    <div class="modal fade" id="exampleModal">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title" id="lessontitle"></h5>
                    <button class="close" data-dismiss="modal">&times;</button>
                </div>

                <div class="modal-body">
                    <div id="lessonDescription"></div>

                    <div class="embed-responsive embed-responsive-16by9 mt-3">
                        <iframe id="lessonLink" src="" frameborder="0" allowfullscreen></iframe>
                    </div>
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>

    <div class="modal fade" id="exampleModal2">
        <div class="modal-dialog modal-dialog-centered modal-lg">
            <div class="modal-content">

                <div class="modal-header">
                    <h5 class="modal-title">Course Code</h5>
                    <button class="close" data-dismiss="modal">&times;</button>
                </div>

                <div class="modal-body">
                    <label><b>Enter the course code to enroll</b></label>
                    <input type="text" class="form-control" id="courseId">
                </div>

                <div class="modal-footer">
                    <button class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button class="btn btn-primary" onclick="enroll()">Enroll</button>
                </div>

            </div>
        </div>
    </div>

    
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.0/dist/js/bootstrap.bundle.min.js"></script>


    <script>

        var email = "";
        var course_title = sessionStorage.getItem("course_title");
        var T_email = sessionStorage.getItem("T_email");

        //authentication check
        firebase.auth().onAuthStateChanged(user => {
            if (user) {
                email = user.email;
                checkEnrollment(); // <--- NEW
                loadCourseHeader();
            } else {
                window.location.href = "login.html";
            }
        });


       //enroll check
        function checkEnrollment() {
            db.collection("students")
                .doc(email)
                .collection("EnrolledCourses")
                .doc(course_title)
                .get()
                .then(doc => {

                    if (doc.exists) {
                        // Student is enrolled → show lessons + projects
                        document.getElementById("lessonSection").style.display = "block";
                        document.getElementById("projectSection").style.display = "block";
                        document.getElementById("enrollBtn").style.display = "none";

                        loadLessons();
                        loadProjects();
                    } else {
                        // Not enrolled → hide them
                        document.getElementById("lessonSection").style.display = "none";
                        document.getElementById("projectSection").style.display = "none";
                        document.getElementById("enrollBtn").style.display = "block";
                    }
                });
        }


        //course header
        function loadCourseHeader() {
            db.collection("teachers").doc(T_email).collection("course")
                .where("course_title", "==", course_title)
                .get()
                .then(qs => {
                    qs.forEach(doc => {
                        let d = doc.data();
                        document.getElementById("courseTitle").innerHTML = d.course_title;
                        document.getElementById("courseDescription").innerHTML = d.course_discription;
                    });
                });
        }


        // load lessons
        function loadLessons() {
            db.collection("teachers").doc(T_email)
                .collection("course").doc(course_title)
                .collection("lessons")
                .get()
                .then(qs => {
                    qs.forEach(doc => {
                        let d = doc.data();
                        let row = `
                            <tr>
                                <td>${d.lesson_title}</td>
                                <td><button class="btn btn-primary" onclick="viewLesson('${d.lesson_title}')" data-toggle="modal" data-target="#exampleModal">View</button></td>
                            </tr>`;
                        document.getElementById("course_table").innerHTML += row;
                    });
                });
        }


      //load projcts
        function loadProjects() {
            db.collection("teachers").doc(T_email)
                .collection("course").doc(course_title)
                .collection("projects")
                .get()
                .then(qs => {
                    qs.forEach(doc => {
                        let d = doc.data();
                        let row = `
                            <tr><td>${d.project_title}</td></tr>`;
                        document.getElementById("course_table1").innerHTML += row;
                    });
                });
        }

        //view lessons
        function viewLesson(lesson_title) {
            db.collection("teachers").doc(T_email)
                .collection("course").doc(course_title)
                .collection("lessons")
                .where("lesson_title", "==", lesson_title)
                .get()
                .then(qs => {
                    qs.forEach(doc => {
                        let d = doc.data();

                        document.getElementById("lessontitle").innerHTML = d.lesson_title;
                        document.getElementById("lessonDescription").innerHTML = d.lesson_discription;

                        let link = d.lesson_link;
                        let videoId = link.split("v=")[1];
                        document.getElementById("lessonLink").src =
                            "https://www.youtube.com/embed/" + videoId;
                    });
                });
        }


        //course enroll function
        function enroll() {
            let enteredCode = document.getElementById("courseId").value;

            // Check course code
            db.collection("teachers").doc(T_email)
                .collection("course").doc(course_title)
                .get()
                .then(doc => {
                    if (!doc.exists) return alert("Course not found.");

                    let data = doc.data();

                    if (data.course_code !== enteredCode) {
                        alert("Invalid Course Code!");
                        return;
                    }

                    // Add to student's enrolled list
                    db.collection("students").doc(email)
                        .collection("EnrolledCourses").doc(course_title)
                        .set({
                            course_title: course_title,
                            teacher_email: T_email,
                            enrolledAt: Date.now()
                        })
                        .then(() => {
                            $("#exampleModal2").modal("hide");
                            alert("Enrollment Successful!");

                            location.reload(); // show lessons/projects
                        });

                });
        }


        function signOut() {
            firebase.auth().signOut().then(() => {
                window.location.href = "login.html";
            });
        }

    </script>

</body>

</html>
